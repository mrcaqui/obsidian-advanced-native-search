## 2025/10/06
### 実施した対応
1. プラグインのビルドパイプライン導入と最小構成の整備。
   - 課題（問題点）  
     既存の Vault で実行可能な形で、TypeScript + esbuild によりビルドし、/plugins-output に自動出力する開発フローが未整備だった。
   - 対応内容（技術的詳細／手順）  
     - TypeScript ソースを `src/main.ts` に集約し、esbuild でバンドルして CommonJS 形式で出力する構成を作成。  
     - `external` に Obsidian/Electron/Codemirror 系を設定し、`target: es2018`、開発時はインラインソースマップ、出力先は `/plugins-output/advanced-native-search/main.js` に設定。  
     - Vault 側は出力先に `manifest.json` を置いて Obsidian が検出・有効化できる状態に統一。  
     - プラグイン機能として、非公式API観測コマンド（SearchView 監視）と公式APIログ出力コマンドを実装・登録。
   - 効果（定量・定性どちらでも可）  
     - 1コマンドで watch ビルドが立ち上がり、保存→即反映で開発ループが高速化。  
     - 出力場所を Vault プラグインフォルダへ固定し、有効化手順が簡略化。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `package.json`  
     - `esbuild.config.mjs`  
     - `tsconfig.json`  
     - `/plugins-output/advanced-native-search/manifest.json`  
     - `src/main.ts`

2. esbuild の watch オプションエラー修正（Invalid option "watch"）。
   - 課題（問題点）  
     `build({ watch })` を指定したことで、利用中の esbuild Node API が `watch` を受け付けずビルド失敗。
   - 対応内容（技術的詳細／手順）  
     - esbuild を 0.19 系に固定。  
     - Node API を `context(options).watch()` に変更し、開発時のみ watch を起動。  
     - 実行スクリプトは `node esbuild.config.mjs [production]` で dev/production を分岐。  
     - `.mjs` 実行の安定化のため `"type": "module"` を `package.json` に追加。
   - 効果（定量・定性どちらでも可）  
     - `npm run dev` で監視ビルドが安定動作し、`/plugins-output/advanced-native-search/main.js` が自動生成されるようになった。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `package.json`  
     - `esbuild.config.mjs`

3. 公式API検索の任意クエリ化（入力モーダル追加）と検索モード切替。
   - 課題（問題点）  
     公式APIログ出力が固定クエリ `"demo"` でヒットが多すぎ、任意の文字列で検索したい要件に未対応。
   - 対応内容（技術的詳細／手順）  
     - `QueryPromptModal` を追加し、実行時に任意クエリを入力可能に。  
     - 検索モードを `fuzzy`（`prepareFuzzySearch`）と `simple`（`prepareSimpleSearch`）から選択可能に。  
     - 新コマンド「ANS: Run official API search logs (prompt for query)」を追加。  
     - `runOfficialApiLogs(query, mode)` へ改修し、既存の固定クエリ版コマンドも併存。
   - 効果（定量・定性どちらでも可）  
     - 利用者が検索語やモードを都度指定でき、ヒット数やマッチ精度を実データに合わせて調整可能に。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `src/main.ts`

4. VSCode の TypeScript エラー修正（tslib 不足・null 可能性・getTags 不在）。
   - 課題（問題点）  
     - TS2354: `"importHelpers": true` だが `tslib` 未導入。  
     - TS18047: `getLeftLeaf(true)` の戻り値が `null` 可能。  
     - TS2339: `MetadataCache.getTags` は存在せずコンパイラエラー。
   - 対応内容（技術的詳細／手順）  
     - 開発依存に `tslib` を追加（または `importHelpers: false` でも可）。  
     - `leaf` へのヌルガードを追加し、取得失敗時は早期リターン。  
     - タグ収集は `CachedMetadata` から集計するユーティリティ `collectTagsFromFiles` を実装（`cache.tags` と `frontmatter.tags` を統合）。
   - 効果（定量・定性どちらでも可）  
     - VSCode の型エラーが解消し、エディタ体験が安定。  
     - タグ一覧出力が API 仕様に沿った実装となり将来互換性が向上。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `package.json`  
     - `tsconfig.json`（任意で `importHelpers` の調整）  
     - `src/main.ts`

5. 動作検証（出力生成とコマンド実行）。
   - 課題（問題点）  
     一連の修正後に、ビルド成果物の生成と Obsidian 上の動作を確認する必要があった。
   - 対応内容（技術的詳細／手順）  
     - `npm run dev` により監視ビルドを起動し、`/plugins-output/advanced-native-search/main.js` が生成されることを確認。  
     - Obsidian でプラグインを有効化し、以下コマンドを実行して結果をコンソールで確認。  
       - 「ANS: Attach native Search observer (Unofficial)」  
       - 「ANS: Run official API search logs (prompt for query)」
   - 効果（定量・定性どちらでも可）  
     - いずれのコマンドも正常に動作し、要件どおりのデータ取得・ログ出力が可能なことを確認。タスク完了。

### 今後のタスク
- 非公式API依存のリスク低減: 内部構造の変化検知ガード、型ナローイング、フェイルセーフ分岐の強化（未取得時の代替経路やユーザ通知）。
- 表示/UI の拡張: 検索結果のカード表示・プレビュー・並び替え・ページング、設定タブでの既定クエリ/モード/ハイライト設定の保存。
- パフォーマンス最適化: 大規模 Vault でのファイル読み込み分割、検索対象の限定（フォルダ/拡張子/サイズ）、非同期キューイング。
- クエリ支援: 入力モーダルに履歴・補完（Suggest）・プリセット（tag:/file:/[property] 例）を追加。
- テスト/型整備: 内部 SearchView のテストダブルや型インターフェイス定義、Obsidian バージョン差分の検証 CI。