## 2025/10/09

### 実施した対応

1. ハイライトと結果モーダルの統一
   • 課題（問題点）  
   既存の `main.ts` と `results-modal.ts` でハイライト/ResultsModal が二重定義され、挙動差（複数パターンの同時ハイライト不可など）と保守コスト増が発生していた。  
   • 対応内容（技術的詳細／手順）  
   ハイライト実装と ResultsModal を `main.ts` に統一。`results-modal.ts` は空ファイルとして重複を解消。レンジ収集（plain/regex/glob）→ マージ → 一括描画の方式に統合し、複数ソース（content/line）の重複範囲も自然にハイライトできるようにした。  
   • 効果（定量・定性どちらでも可）  
   複数条件の同時ヒットが正しく可視化され、UX の一貫性が向上。コードの重複削減により保守性が改善。  
   • 変更ファイル（パス）  
   `main.ts`、`results-modal.ts`

2. Regex ヒット件数の正確化
   • 課題（問題点）  
   `String.match` のフラグ依存により、正規表現ヒット件数が過小カウントとなる可能性があった（/g 未指定時）。  
   • 対応内容（技術的詳細／手順）

   - カウント用途は常にグローバル化した正規表現を用い、`matchAll` で件数を算出（`ensureGlobalRegex`/`countRegexMatches` を新設）。
   - 本文・各ターゲット（name/path/frontmatter/tags/headings）に対する件数集計で上記関数を適用。
   - 行ごとの判定は lastIndex 影響を避けるため、非グローバルの検索用 RegExp を別管理。  
     • 効果（定量・定性どちらでも可）  
     Regex モードでのヒット件数が常に正確に集計されるようになり、検索結果の信頼性が向上。  
     • 変更ファイル（パス）  
     `main.ts`

3. limit と sort の順序の見直し（事前ソート → 早期打ち切り方式を採用）
   • 課題（問題点）  
   ループ中の件数到達で break→ 最後に sort していたため、「並べ替え後の上位 N 件」とは限らなかった。  
   • 対応内容（技術的詳細／手順）  
   (b) 事前にファイル一覧を sort してから走査（早期打ち切り可）を採用。選択した基準（mtime/path）で事前ソートし、その順でフィルタ・評価し、limit 到達で中断。  
   • 効果（定量・定性どちらでも可）  
   期待どおり「選択ソート基準での上位 N 件」を高速に取得可能。全件収集不要のためパフォーマンスと実装のシンプルさを両立。  
   • 変更ファイル（パス）  
   `main.ts`

4. 未使用 `results-modal.ts` の整理と挙動差解消
   • 課題（問題点）  
   実際には使用されない `results-modal.ts` が存在し、ハイライト挙動の差分や将来的な仕様不一致のリスクがあった。  
   • 対応内容（技術的詳細／手順）  
   `results-modal.ts` を空定義に変更し、実装は `main.ts` に統一。コメントで統一方針を明示。  
   • 効果（定量・定性どちらでも可）  
   二重管理を解消し、今後の変更点が単一箇所に集約。バグ混入リスクと保守コストを低減。  
   • 変更ファイル（パス）  
   `results-modal.ts`、`main.ts`

5. 正規表現の大文字小文字扱いの UI 明示
   • 課題（問題点）  
   caseSensitive の適用範囲（filters のみ）および Global Query の regex フラグ挙動が UI 上で分かりづらかった。  
   • 対応内容（技術的詳細／手順）  
   Global Query セクションに注意書きを追加。「Case sensitive はフィルタのみ」「Global Query は explicit flags のみ尊重」「regex モードで flags を指定しない場合はデフォルト i」を明示。  
   • 効果（定量・定性どちらでも可）  
   設定の意味が明確になり、ユーザの混乱や意図しない検索結果を抑制。  
   • 変更ファイル（パス）  
   `main.ts`

6. 3 ファイル構成へのリファクタリング（main.ts 分割）。
   • 課題（問題点）：単一ファイル `main.ts` が肥大化し、可読性・保守性・役割分離が困難になっていた。  
   • 対応内容（技術的詳細／手順）：機能を 3 グループに整理し、`src/plugin.ts`（プラグイン本体：コマンド登録・UI 起動・検索呼び出し）、`src/search.ts`（検索エンジン・型・ユーティリティ）、`src/ui.ts`（クエリ入力モーダル・結果モーダル・ハイライト）へ分割。型は `search.ts` に集約し、`plugin.ts` は `ui.ts`／`search.ts` をインポートする構成へ変更。  
   • 効果（定量・定性）：モジュール間の責務が明確化し、コード理解・変更容易性が向上。今後の機能拡張（検索演算や UI 改善）の影響範囲が限定され、リグレッションリスク低減。  
   • 変更ファイル：`src/plugin.ts`、`src/search.ts`、`src/ui.ts`、`src/main.ts`（必要に応じて作成）。

7. ビルドエラーの解消（esbuild エントリポイント不整合）。
   • 課題（問題点）：`esbuild` が `src/main.ts` を解決できず、「Could not resolve "src/main.ts"」でビルド失敗。分割後のエントリポイントが `plugin.ts` に変わったことが原因。  
   • 対応内容（技術的詳細／手順）：方法 A として `esbuild.config.mjs` の `entryPoints` を `"src/plugin.ts"` に変更。方法 B として `src/main.ts` を追加し `./plugin` を再エクスポート（`export default`）する薄いラッパーを作成。いずれかを適用しビルド成功を確認。  
   • 効果（定量・定性）：`npm run dev` が正常起動し、`/plugins-output/advanced-native-search/main.js` が生成されるようになった。開発サイクルが復旧。  
   • 変更ファイル：`esbuild.config.mjs`、`src/main.ts`（方法 B の場合）。

8. 動作確認。
   • 課題（問題点）：ファイル分割後の機能整合性と UI の起動・連携確認が必要。  
   • 対応内容（技術的詳細／手順）：Obsidian 上でコマンド登録・クエリ入力モーダル起動・検索実行・結果モーダル表示までを通しで確認。フィルタ（file/path/tag/content/line/headings）の AND 評価、Global Query の複数ターゲット OR 評価、抜粋生成・ハイライト・行ジャンプ動作を手動テスト。  
   • 効果（定量・定性）：分割後も既存機能の後方互換性を維持し、期待どおりの検索・表示動作を確認。開発体制移行の安全性を担保。

9. 常駐型の結果ビュー導入と Split/Window トグル実装。
   • 課題（問題点）  
   モーダル表示だと結果が一過性で、センター領域を活用した常駐表示や Split/Window の柔軟な切り替えができなかった。  
   • 対応内容（技術的詳細／手順）

   - カスタムビュー VIEW_TYPE_ANS_RESULTS を登録し、ItemView を継承した ResultsView を新設。registerView でワークスペースのリーフにセット可能にした。
   - plugin 側で showResults を実装し、分割表示（split）とポップアウト（window）を即時切り替え。片方へ切り替え時はもう片方のリーフを detach してクローズ。
   - ensureSplitResultsView と ensureWindowResultsView を用意し、既存リーフがあれば再利用、なければ生成。leaf.setPinned(true) で結果ペインをピン留め。
   - 結果 UI は既存の ResultsModal 相当の抜粋カード／クリックで行ジャンプ／ハイライトを ResultsView.render に移植して維持。
   - トグル（Split/Window）は ResultsView のヘッダーに配置。クリックで plugin.requestSwitchDisplayMode を呼び、切替後は反対モードのリーフを閉じる。
   - デフォルトの表示モード（split/window）を settings に保存・読み込みし、次回検索時に適用。  
     • 効果（定量・定性どちらでも可）  
     モーダル依存を解消し、センター領域での常駐表示と即時トグル切替を実現。結果ペインをピン留めしてもノート遷移に影響されず、再検索も同ペインへ高速再描画。UX は既存の抜粋・ハイライト・行ジャンプを維持。  
     • 変更ファイル（パスを `back-tick` で囲む）  
     `src/plugin.ts`、`src/resultsView.ts`、`src/ui.ts`

10. TypeScript 型エラーの解消（Obsidian API の型定義に準拠）。
    • 課題（問題点）

    - registerView の ViewCreator シグネチャ不一致（onOpen/onClose の戻りが Promise<void> 必須）。
    - workspace.on のイベント名・シグネチャ不一致。
    - leaf.view の型が汎用 View であり、ResultsView への直接キャストでエラー。  
      • 対応内容（技術的詳細／手順）
    - ResultsView の onOpen/onClose を async Promise<void> に修正。
    - 不要かつ非対応の "leaf-detached" 監視を削除（リーフの生存管理は ensure\*/detach の明示制御に集約）。
    - leaf.view のダウンキャストは as unknown as ResultsView に変更し、型安全性を担保しつつビルドを通す。  
      • 効果（定量・定性どちらでも可）  
      ビルドエラーが解消され、開発環境（VS Code）上の型検査がクリーンに。ランタイムの安定性も向上。  
      • 変更ファイル（パスを `back-tick` で囲む）  
      `src/plugin.ts`、`src/resultsView.ts`

11. 外枠リサイズ時の内枠見切れ改善（レイアウト修正）。
    • 課題（問題点）  
    ビュー外枠を縦長に拡大しても、内側の結果リストが max-height 制約で伸びず、下部が見切れてしまう。  
    • 対応内容（技術的詳細／手順）

    - ルート要素（contentEl）を高さ 100%の縦方向 Flex に設定（display:flex、flex-direction:column、height:100%、min-height:0）。
    - リスト領域の親ラッパーを flex:1 かつ min-height:0 にし、空間を余すことなく占有。
    - リスト自体も flex:1 かつ overflow:auto にして、内容が溢れるときのみスクロール。
    - 固定の maxHeight: 70vh を撤廃し、外枠サイズに連動するように変更。  
      • 効果（定量・定性どちらでも可）  
      Split/Window いずれでも外枠いっぱいにコンテンツが広がり、見切れが解消。必要な場合のみスムーズにスクロール。  
      • 変更ファイル（パスを `back-tick` で囲む）  
      `src/resultsView.ts`

12. • 課題（問題点）  
    Global Query、Filters、Common Options で左カラムが左寄せにならず余白が不均一、またセクション間でレイアウトが揃っていない。  
    • 対応内容（技術的詳細／手順）  
    共通レイアウト関数 createSettingItem を全セクションで使用し、2 カラム構成を統一。左カラムは独自クラス（qpm-）でテーマ由来の余白・インデントを打ち消し、text-align を left に統一。右カラムは縦積みのまま stretch 配置で幅いっぱいに広がるように調整。  
    • 効果（定量・定性どちらでも可）  
    全セクションで左カラムが均一に左寄せ表示され、視線移動と可読性が改善。UI の一貫性向上。  
    • 変更ファイル（パスを `back-tick` で囲む）  
    `ui.ts`

13. • 課題（問題点）  
    一部コントロールが中央寄りになり、Filters のテキストボックスが極端に狭く潰れて文字入力が困難。  
    • 対応内容（技術的詳細／手順）  
    右カラム（controlEl）に align-items: stretch を適用し、各入力行に flex レイアウトを適用。input/select に対して flex: 1 1 0、min-width: 0、width: 100% を設定し、親幅へ自然に拡張。チップエリアは右寄せ維持（justify-content: flex-end）。  
    • 効果（定量・定性どちらでも可）  
    全ての入力欄が右カラムの横幅を有効に使い、入力のしやすさが大幅改善。中央寄り問題も解消。  
    • 変更ファイル（パスを `back-tick` で囲む）  
    `ui.ts`

14. • 課題（問題点）  
    左右カラムの幅比が 1:2 に見え、均等割りではない。説明文のフォントサイズが見出し（項目名）と同じに見える。  
    • 対応内容（技術的詳細／手順）  
    gridTemplateColumns を 1fr 1fr に設定し、左右カラムを 1:1（均等割）に固定。説明テキストには Obsidian 既定の説明スタイルを付与（cls: "setting-item-description"）し、セクション説明と同等のフォントサイズ／色に統一。  
    • 効果（定量・定性どちらでも可）  
    視覚的バランスが改善し、項目名と説明の階層が明確化。読みやすさとプロ感のある見た目に向上。  
    • 変更ファイル（パスを `back-tick` で囲む）  
    `ui.ts`

### 今後のタスク

- 各テーマ（ライト／ダーク、カスタムテーマ）での表示検証と微調整（特に説明色と余白の整合）。
- ウィンドウ幅が極端に狭い場合のレスポンシブ対応（ブレークポイントで縦 1 カラムへフォールバック）。
- Targets グリッドの最小幅見直し（minmax 値の最適化）とアクセシビリティ（Tab 移動順、ラベル関連付け）の確認。
- エラーメッセージや Notice の表現統一と多言語対応の検討。

## 2025/10/07

### 実施した対応

1.  • 課題（問題点）  
    全フィルタ（file, path, tag, content, line, section, block, property, task）の組み合わせが一部 OR として扱われる可能性があり、ネイティブ検索の「Search term」表示（AND 論理）と乖離する場面があった。

    • 対応内容（技術的詳細／手順）

    - UI で追加した各フィルタをすべて AND 条件で評価するよう統一した。
    - 具体的には、UI のチップ追加（「＋」）で 1 つずつ追加したフィルタを配列に保持し、検索時に `every(...)` による AND 判定でフィルタリングするように修正した。
    - `line` は語を 1 つずつ追加したものを AND として解釈し、内部で `buildLineRegexLiteral_AND` により `/^(?=.*term1)(?=.*term2).*$/i` のような lookahead 正規表現を生成して、同一行に全語が存在することを判定するようにした。

    • 効果（定量・定性どちらでも可）  
    ネイティブ検索の「Match all of」に整合する論理で揺らぎが解消され、複雑なクエリでも期待どおりの絞り込みができるようになった。ユーザーは「har」を追加し、次に「tool」を追加すれば、同じ行に両方含まれている必要があることが直感的に理解できる。

    • 変更ファイル（パス）  
    `main.ts`

2.  • 課題（問題点）  
    `line` の UI で語を追加すると自動的に括弧表示（例: `(har tool)`)になり、グループ化の意味が分かりづらく、操作の混乱につながっていた。

    • 対応内容（技術的詳細／手順）

    - `line` の UI を「語を 1 つずつチップ追加（AND）」方式に変更し、括弧表示は廃止した。
    - スペース区切りで複数語を入力した場合も、内部でトークナイズして各語を個別チップとして追加（AND）する仕様に統一。
    - 検索時に `lineTerms` を AND でまとめて 1 本の lookahead 正規表現にコンパイル（`buildLineRegexLiteral_AND`）、`countLineMatches_AND` で該当行（ユニーク行）を集計する仕組みに刷新。

    • 効果（定量・定性どちらでも可）  
    UI の挙動がシンプルになり、ユーザーは「必要な語を順に追加すれば AND になる」というルールに集中できる。意図しないグループ化による誤解が解消された。

    • 変更ファイル（パス）  
    `main.ts`

3.  • 課題（問題点）  
    既定の検索モードが `fuzzy` で、ユーザー期待（Simple 検索が基本）と異なる初期挙動になっていた。

    • 対応内容（技術的詳細／手順）

    - モーダルのモード選択のデフォルトを `simple` に変更。
    - 本文クエリが指定された場合は `prepareSimpleSearch` を既定で使用し、明示的に `fuzzy` や `regex` を選んだ場合のみ切り替える。

    • 効果（定量・定性どちらでも可）  
    期待される基本動作に一致し、結果の安定性と操作感の一貫性が向上。簡易検証時の手戻りが減少した。

    • 変更ファイル（パス）  
    `main.ts`

4.  • 課題（問題点）  
    検索結果の集計・ログ表示が分かりづらく、ネイティブ検索の見え方と比較しづらかった。

    • 対応内容（技術的詳細／手順）

    - 検索ログを「マッチしたファイル数」と「line ヒット数（ユニーク行）」に分けて表示するように整理。
    - `file:` はあくまでフィルタとして扱い、件数加算の対象外とした。`line` は AND 条件で行単位のヒット数を集計し、詳細（行番号）も併記。

    • 効果（定量・定性どちらでも可）  
    集計の意味が明確になり、ネイティブの「Search term（AND）」との論理整合性の確認が容易になった。検証作業の時間短縮につながった。

    • 変更ファイル（パス）  
    `main.ts`

5.  検索結果の「ヒット行抜粋」を開発者コンソールへ出力できるように改修。
    • 課題（問題点）: ネイティブ検索のような本文抜粋が表示されず、どの行がヒットしたのか把握しづらかった。  
    • 対応内容（技術的詳細／手順）: `Excerpt` 型の新設と、行単位でヒット理由を集約する `extractHitLines()` を追加。`MatchLog` に `excerpts?: Excerpt[]` を拡張し、`runNativeLikeSearch()` 内で本文取得後に抜粋を生成・格納。最後に `console.groupCollapsed()` を用いて「行番号: 抜粋テキスト」と「reasons（どの条件でヒットしたか）」を最大 10 行まで出力するロギングを追加。各行のヒット理由は以下で検出:

    - `line:` 用の AND 先読み正規表現（生成済みリテラル）を行ごとに適用。
    - `content:` で追加した各パターンを `contentContains()` で行ごとに適用。
    - 本文クエリが `simple/fuzzy` の場合は `prepare*Search` の `searchFn` を行テキストに適用、`regex` の場合は `regexForContentQuery.test()` を適用。  
       長すぎる行は `formatLineForLog()` で整形し、ログ過多防止のため抜粋は 1 ファイル最大 10 行に制限。  
      • 効果（定量・定性）: 検索後すぐに「どの行が・どの条件で」ヒットしたかを把握可能になり、デバッグ・調整の手戻りを削減。大規模ノートでもログ視認性が向上（グループ化・行制限でノイズ低減）。  
      • 変更ファイル: `main.ts`

6.  開発者ログの出力仕様を改善（フィルタ別の詳細内訳と不要ログの削除）。
    • 課題（問題点）: ログに不要情報が含まれ、重要指標が不明確だった。具体的には「[ANS] UI 状態（line terms）」が冗長、「[ANS] 対象ファイル数」が何を指すか曖昧、集計が全フィルタまとめてで各フィルタの内訳が把握しづらい、さらに「ヒット行 ○ 件 — path」ログが重複情報だった。  
    • 対応内容（技術的詳細／手順）:

    - 「[ANS] UI 状態（line terms）」のログを削除。
    - 「[ANS] 対象ファイル数」を「Vault 内の Markdown ファイル（app.vault.getMarkdownFiles() の結果）件数」と明示するメッセージへ修正。
    - 採用ファイルに対してフィルタ別の内訳ログを追加（file/path/tag/property/section/block/tasks/content/line/contentQuery）。各フィルタの評価基準をログに明示した上で、ファイルごとの一致件数を出力。  
      ・file/path: `matchPattern()` により各パターン一致数を集計。  
      ・tag: `getTagsForFile()`＋正規表現／集合照合で一致数を集計。  
      ・property: `matchProperty()` により一致数を集計。  
      ・section: `matchSection()`、block: `matchBlockId()` により一致数を集計。  
      ・tasks: `cache.listItems` から条件（any/todo/done）に合致するタスク件数を集計。  
      ・content: 本文全体に対して `contentContains()` で各パターン一致数を集計。  
      ・line: AND 条件でのユニーク行ヒット数（`countLineMatches_AND()` の結果）を出力。  
      ・contentQuery: simple/fuzzy は行単位で `searchFn` による一致行数、regex は本文全体の正規表現一致総数。  
      内訳集計用に `FilterHitStats` 型を追加し、採用ファイルごとに `filterHits` を格納。
    - 重複確認可能なため「[ANS] ヒット行 ○ 件 — path」グループ出力を削除（「結果サンプル」「全結果」で確認可能）。  
      • 効果（定量・定性どちらでも可）: ログの冗長さを削減し、各フィルタがどのようにヒットしたかを明確化。デバッグの観点で検証ポイントが直感的になり、調査時間を短縮。対象ファイル範囲の誤解も防止。  
      • 変更ファイル（パスを `back-tick` で囲む）: `main.ts`

7.  Section フィルタのヒット行を抜粋情報（excerpts）に反映。

- 課題（問題点）: Section フィルタで採用されたファイルでも、どの見出し行に一致したかが excerpts に出力されず、ヒット箇所が把握できない状態だった。
- 対応内容（技術的詳細／手順）:
  - 見出しキャッシュから一致行を抽出するユーティリティを追加し、行番号と行テキストを抜粋として生成。
    - 追加関数: `offsetToLine(text, offset)`（position.start.line がない場合のフォールバック）。
    - 追加関数: `buildSectionExcerpts(app, file, text, patterns, caseSensitive)`（`sources` に `section:<pattern>` を付与）。
  - 既存の抜粋と見出し由来の抜粋を統合する関数を実装。
    - 追加関数: `mergeExcerpts(base, add, perFileLimit)`（行番号でマージ、`sources` を結合、上限適用）。
  - 検索実行ロジックで excerpts 生成後にセクション抜粋を生成・マージするよう組み込み。
    - `runNativeLikeSearch` 内で `buildSectionExcerpts(...)` を呼び出し、`mergeExcerpts(...)` で統合して `logEntry.excerpts` に設定。
- 効果（定量・定性どちらでも可）: Section 一致時に「どの行・どのテキストにヒットしたか」を excerpts で確認可能になり、デバッグ性・追跡性が向上。複数パターンに同一見出しが一致した場合も、`sources` に複数の `section:<pattern>` が記録され、判定根拠が明瞭化。
- 変更ファイル（パスを `back-tick` で囲む）: `main.ts`

8.  • 課題（問題点）  
    本文に限定された検索は用途が分かりづらく、Vault 横断の利用ニーズを満たしていなかった。

    • 対応内容（技術的詳細／手順）

    - 「本文クエリ」を「Global Query」に改称し、型・変数名を包括的にリネーム（contentQuery → globalQuery、contentQueryTargets → globalQueryTargets など）。
    - Global Query の対象を Body/Name/Path/Frontmatter/Tags/Headings に拡張し、対象内は OR（いずれか命中）で判定。
    - simple/fuzzy は Obsidian の prepareSimpleSearch/prepareFuzzySearch を用いて文字列評価、regex は明示リテラルを優先し、それ以外はデフォルトで大文字小文字非区別に。
    - 非本文ターゲットの命中を擬似抜粋として表示（[name] / [path] / [frontmatter] / [tag] / [headings]）。
    - ヒット内訳に globalQueryBreakdown（target 別件数）を追加。

    • 効果（定量・定性どちらでも可）  
    検索の網羅性・説明性が向上し、使用意図が明確化。Vault 横断の発見性が改善。

    • 変更ファイル  
    `/workspaces/obsidian-advanced-native-search/src/main.ts`

9.  • 課題（問題点）  
    Global Query とフィルタの影響範囲（モード／大文字小文字）が不明瞭で誤解を招く。

    • 対応内容（技術的詳細／手順）

    - モーダル UI に「Global Query セクション（Mode 適用）」と「Filters セクション（Case sensitive 適用）」を明示分割し、区切り線・見出しを追加。
    - 仕様を統一: Mode は Global Query のみ、Case sensitive は file/path/tag/content/line/headings/property の各フィルタに適用。
    - regex（Global Query）は明示フラグ優先・非明示は非区別で統一。

    • 効果（定量・定性どちらでも可）  
    誤設定の低減と再現性の向上。操作学習コストの削減。

    • 変更ファイル  
    `/workspaces/obsidian-advanced-native-search/src/main.ts`

10. • 課題（問題点）  
    使用しない block / task 機能がコードを複雑化し、型エラーの温床になっていた。

• 対応内容（技術的詳細／手順）

- block / task 関連の UI・型・ロジック・統計・ログを全面削除。
- 参照関数や内訳表示も削除し、依存コードを整理。

• 効果（定量・定性どちらでも可）  
 コード行数削減、ビルド安定性と可読性・保守性の向上。

• 変更ファイル  
 `/workspaces/obsidian-advanced-native-search/src/main.ts`

11. • 課題（問題点）  
    「section」表記が実態（見出し検索）と乖離していた。

• 対応内容（技術的詳細／手順）

- section → headings に改称（UI/型/ログ/統計キーを一括更新）。
- matchSection → matchHeading、buildSectionExcerpts → buildHeadingExcerpts に置換。
- position.start.line 不在時は position.start.offset から offsetToLine で行番号を推定。

• 効果（定量・定性どちらでも可）  
 用語と機能の一貫性が向上し、デバッグと理解コストを削減。

• 変更ファイル  
 `/workspaces/obsidian-advanced-native-search/src/main.ts`

12. • 課題（問題点）  
    （副次）ListItemCache.text 参照に起因する ts(2339) などの型不一致が発生していた。

• 対応内容（技術的詳細／手順）

- task 機能の全面削除により当該参照自体を排除。
- 行位置計算の共通化（offsetToLine の積極利用）で位置推定の一貫性を確保。

• 効果（定量・定性どちらでも可）  
 ビルド時エラーの解消と安定性向上。

• 変更ファイル  
 `/workspaces/obsidian-advanced-native-search/src/main.ts`

13. • 課題（問題点）  
    コメントや UI 文言が日本語混在で国際化・コントリビューションに不利。

• 対応内容（技術的詳細／手順）

- 主要コメント／UI ラベル／ログ出力を英語に統一。

• 効果（定量・定性どちらでも可）  
 外部コントリビュータの参画ハードル低下、保守性向上。

• 変更ファイル  
 `/workspaces/obsidian-advanced-native-search/src/main.ts`

14. • 課題（問題点）  
    ヒット根拠の可視性が不足し、診断が難しい。

• 対応内容（技術的詳細／手順）

- Global Query の非本文ターゲットに対し擬似抜粋を生成・統合。
- filterHits に globalQueryBreakdown（target 別）を追加し、console.groupCollapsed で可読性向上。

• 効果（定量・定性どちらでも可）  
 デバッグ効率と問題切り分けの精度が向上。

• 変更ファイル  
 `/workspaces/obsidian-advanced-native-search/src/main.ts`

15. • 課題（問題点）: 検索結果が開発者コンソール出力のみで、ユーザーが UI 上で結果を参照・遷移できなかった。  
    • 対応内容（技術的詳細／手順）: 検索後に結果をモーダルで表示する「ResultsModal」を`main.ts`へ実装・統合。ファイル単位でグループ化し、ヘッダーにファイル名・パス・ヒット数・サイズ・更新日時を表示。各ヒット箇所は枠付きカードとして`excerpts`を列挙し、`Line n`と`sources`を付記。カードクリックで`workspace.openLinkText`により該当ファイルを開き、`editor.setCursor`と`scrollIntoView`（なければ`view.revealLine`）で該当行へスクロール（合成行`line:-1`はスクロールなし）。既存の検索処理（prepareSimpleSearch/prepareFuzzySearch/regex、excerpts 生成、ブレークダウン出力）は維持し、末尾でモーダルを起動。UI は 70vh のスクロール可能領域、ホバーで背景色変化を実装。  
    • 効果（定量・定性どちらでも可）: 検索結果をネイティブ検索風に UI 表示でき、コンソールに依存せず結果把握と該当箇所への即時遷移が可能に。既存ロジック変更最小で導入、体感操作性向上。  
    • 変更ファイル（パスを `back-tick` で囲む）: `main.ts`

16. • 課題（問題点）: ヒット箇所の可視性が低く、どの語句・パターンで一致したかがわかりづらかった。  
    • 対応内容（技術的詳細／手順）: `excerpt.sources`の`content:<pattern>`と`matched.lineTerms`を用いてハイライトを実装。XSS 対策として`escapeHTML`を実装。ハイライト範囲抽出は以下の方針で実装し、重複・隣接範囲を`mergeRanges`で集約し`<mark>`で囲む方式に統一。
    - 明示的正規表現`/pattern/flags`: `matchAll`で全一致範囲を抽出（`g`付与）。
    - グロブ`*`/`?`: `globToRegExp`で RegExp 化し全一致抽出。
    - 部分一致: 大文字小文字指定に合わせて線形走査で全一致抽出。
    - `computeHighlightedHTML`で`contentPatterns`と`lineTerms`を統合して HTML 構築（`caseSensitive`反映）。  
      • 効果（定量・定性どちらでも可）: 一致語句が視覚的に強調され、結果の理解速度が向上。正規表現・グロブ・プレーンを横断的に網羅し、誤検知や HTML 破壊のない安全な描画を実現。  
      • 変更ファイル（パスを `back-tick` で囲む）: `main.ts`

### 今後のタスク

- Global Query のハイライト対応（結果 JSON に`globalQueryString`と`mode`を追加し、`globalQuery:*`ソースに基づく本文・見出し・タグ・パス・ファイル名・フロントマターのハイライトを実装）。
- 結果を固定表示するカスタムビュー（`registerView`）の実装（右ペイン常設、クエリ再実行なしで参照可能）。
- 結果件数のページング／抜粋上限・表示設定（1 ファイルあたりの抜粋数、ヒット順の並び替え）を設定化。
- 遷移挙動のオプション化（新規ペインで開く／プレビューで開く、前後ヒットへのキーボードナビゲーション）。
- 大量結果向けのパフォーマンス最適化（仮想リスト化、非同期レンダリング）。
- 結果のコピー／エクスポート（JSON/Markdown）機能。
- テーマ連携・アクセシビリティ改善（コントラスト、スクリーンリーダー対応、ローカライズ整備）。

## 2025/10/06

### 実施した対応

1. プラグインのビルドパイプライン導入と最小構成の整備。

   - 課題（問題点）  
     既存の Vault で実行可能な形で、TypeScript + esbuild によりビルドし、/plugins-output に自動出力する開発フローが未整備だった。
   - 対応内容（技術的詳細／手順）
     - TypeScript ソースを `src/main.ts` に集約し、esbuild でバンドルして CommonJS 形式で出力する構成を作成。
     - `external` に Obsidian/Electron/Codemirror 系を設定し、`target: es2018`、開発時はインラインソースマップ、出力先は `/plugins-output/advanced-native-search/main.js` に設定。
     - Vault 側は出力先に `manifest.json` を置いて Obsidian が検出・有効化できる状態に統一。
     - プラグイン機能として、非公式 API 観測コマンド（SearchView 監視）と公式 API ログ出力コマンドを実装・登録。
   - 効果（定量・定性どちらでも可）
     - 1 コマンドで watch ビルドが立ち上がり、保存 → 即反映で開発ループが高速化。
     - 出力場所を Vault プラグインフォルダへ固定し、有効化手順が簡略化。
   - 変更ファイル（パスを `back-tick` で囲む）
     - `package.json`
     - `esbuild.config.mjs`
     - `tsconfig.json`
     - `/plugins-output/advanced-native-search/manifest.json`
     - `src/main.ts`

2. esbuild の watch オプションエラー修正（Invalid option "watch"）。

   - 課題（問題点）  
     `build({ watch })` を指定したことで、利用中の esbuild Node API が `watch` を受け付けずビルド失敗。
   - 対応内容（技術的詳細／手順）
     - esbuild を 0.19 系に固定。
     - Node API を `context(options).watch()` に変更し、開発時のみ watch を起動。
     - 実行スクリプトは `node esbuild.config.mjs [production]` で dev/production を分岐。
     - `.mjs` 実行の安定化のため `"type": "module"` を `package.json` に追加。
   - 効果（定量・定性どちらでも可）
     - `npm run dev` で監視ビルドが安定動作し、`/plugins-output/advanced-native-search/main.js` が自動生成されるようになった。
   - 変更ファイル（パスを `back-tick` で囲む）
     - `package.json`
     - `esbuild.config.mjs`

3. 公式 API 検索の任意クエリ化（入力モーダル追加）と検索モード切替。

   - 課題（問題点）  
     公式 API ログ出力が固定クエリ `"demo"` でヒットが多すぎ、任意の文字列で検索したい要件に未対応。
   - 対応内容（技術的詳細／手順）
     - `QueryPromptModal` を追加し、実行時に任意クエリを入力可能に。
     - 検索モードを `fuzzy`（`prepareFuzzySearch`）と `simple`（`prepareSimpleSearch`）から選択可能に。
     - 新コマンド「ANS: Run official API search logs (prompt for query)」を追加。
     - `runOfficialApiLogs(query, mode)` へ改修し、既存の固定クエリ版コマンドも併存。
   - 効果（定量・定性どちらでも可）
     - 利用者が検索語やモードを都度指定でき、ヒット数やマッチ精度を実データに合わせて調整可能に。
   - 変更ファイル（パスを `back-tick` で囲む）
     - `src/main.ts`

4. VSCode の TypeScript エラー修正（tslib 不足・null 可能性・getTags 不在）。

   - 課題（問題点）
     - TS2354: `"importHelpers": true` だが `tslib` 未導入。
     - TS18047: `getLeftLeaf(true)` の戻り値が `null` 可能。
     - TS2339: `MetadataCache.getTags` は存在せずコンパイラエラー。
   - 対応内容（技術的詳細／手順）
     - 開発依存に `tslib` を追加（または `importHelpers: false` でも可）。
     - `leaf` へのヌルガードを追加し、取得失敗時は早期リターン。
     - タグ収集は `CachedMetadata` から集計するユーティリティ `collectTagsFromFiles` を実装（`cache.tags` と `frontmatter.tags` を統合）。
   - 効果（定量・定性どちらでも可）
     - VSCode の型エラーが解消し、エディタ体験が安定。
     - タグ一覧出力が API 仕様に沿った実装となり将来互換性が向上。
   - 変更ファイル（パスを `back-tick` で囲む）
     - `package.json`
     - `tsconfig.json`（任意で `importHelpers` の調整）
     - `src/main.ts`

5. 動作検証（出力生成とコマンド実行）。
   - 課題（問題点）  
     一連の修正後に、ビルド成果物の生成と Obsidian 上の動作を確認する必要があった。
   - 対応内容（技術的詳細／手順）
     - `npm run dev` により監視ビルドを起動し、`/plugins-output/advanced-native-search/main.js` が生成されることを確認。
     - Obsidian でプラグインを有効化し、以下コマンドを実行して結果をコンソールで確認。
       - 「ANS: Attach native Search observer (Unofficial)」
       - 「ANS: Run official API search logs (prompt for query)」
   - 効果（定量・定性どちらでも可）
     - いずれのコマンドも正常に動作し、要件どおりのデータ取得・ログ出力が可能なことを確認。タスク完了。

### 今後のタスク

- 非公式 API 依存のリスク低減: 内部構造の変化検知ガード、型ナローイング、フェイルセーフ分岐の強化（未取得時の代替経路やユーザ通知）。
- 表示/UI の拡張: 検索結果のカード表示・プレビュー・並び替え・ページング、設定タブでの既定クエリ/モード/ハイライト設定の保存。
- パフォーマンス最適化: 大規模 Vault でのファイル読み込み分割、検索対象の限定（フォルダ/拡張子/サイズ）、非同期キューイング。
- クエリ支援: 入力モーダルに履歴・補完（Suggest）・プリセット（tag:/file:/[property] 例）を追加。
- テスト/型整備: 内部 SearchView のテストダブルや型インターフェイス定義、Obsidian バージョン差分の検証 CI。
