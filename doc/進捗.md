## 2025/10/07
### 実施した対応
1. 
   • 課題（問題点）  
   全フィルタ（file, path, tag, content, line, section, block, property, task）の組み合わせが一部ORとして扱われる可能性があり、ネイティブ検索の「Search term」表示（AND論理）と乖離する場面があった。  

   • 対応内容（技術的詳細／手順）  
   - UIで追加した各フィルタをすべてAND条件で評価するよう統一した。  
   - 具体的には、UIのチップ追加（「＋」）で1つずつ追加したフィルタを配列に保持し、検索時に `every(...)` によるAND判定でフィルタリングするように修正した。  
   - `line` は語を1つずつ追加したものをANDとして解釈し、内部で `buildLineRegexLiteral_AND` により `/^(?=.*term1)(?=.*term2).*$/i` のようなlookahead正規表現を生成して、同一行に全語が存在することを判定するようにした。  

   • 効果（定量・定性どちらでも可）  
   ネイティブ検索の「Match all of」に整合する論理で揺らぎが解消され、複雑なクエリでも期待どおりの絞り込みができるようになった。ユーザーは「har」を追加し、次に「tool」を追加すれば、同じ行に両方含まれている必要があることが直感的に理解できる。  

   • 変更ファイル（パス）  
   `main.ts`  

2. 
   • 課題（問題点）  
   `line` のUIで語を追加すると自動的に括弧表示（例: `(har tool)`)になり、グループ化の意味が分かりづらく、操作の混乱につながっていた。  

   • 対応内容（技術的詳細／手順）  
   - `line` のUIを「語を1つずつチップ追加（AND）」方式に変更し、括弧表示は廃止した。  
   - スペース区切りで複数語を入力した場合も、内部でトークナイズして各語を個別チップとして追加（AND）する仕様に統一。  
   - 検索時に `lineTerms` をANDでまとめて1本のlookahead正規表現にコンパイル（`buildLineRegexLiteral_AND`）、`countLineMatches_AND` で該当行（ユニーク行）を集計する仕組みに刷新。  

   • 効果（定量・定性どちらでも可）  
   UIの挙動がシンプルになり、ユーザーは「必要な語を順に追加すればANDになる」というルールに集中できる。意図しないグループ化による誤解が解消された。  

   • 変更ファイル（パス）  
   `main.ts`  

3. 
   • 課題（問題点）  
   既定の検索モードが `fuzzy` で、ユーザー期待（Simple検索が基本）と異なる初期挙動になっていた。  

   • 対応内容（技術的詳細／手順）  
   - モーダルのモード選択のデフォルトを `simple` に変更。  
   - 本文クエリが指定された場合は `prepareSimpleSearch` を既定で使用し、明示的に `fuzzy` や `regex` を選んだ場合のみ切り替える。  

   • 効果（定量・定性どちらでも可）  
   期待される基本動作に一致し、結果の安定性と操作感の一貫性が向上。簡易検証時の手戻りが減少した。  

   • 変更ファイル（パス）  
   `main.ts`  

4. 
   • 課題（問題点）  
   検索結果の集計・ログ表示が分かりづらく、ネイティブ検索の見え方と比較しづらかった。  

   • 対応内容（技術的詳細／手順）  
   - 検索ログを「マッチしたファイル数」と「lineヒット数（ユニーク行）」に分けて表示するように整理。  
   - `file:` はあくまでフィルタとして扱い、件数加算の対象外とした。`line` はAND条件で行単位のヒット数を集計し、詳細（行番号）も併記。  

   • 効果（定量・定性どちらでも可）  
   集計の意味が明確になり、ネイティブの「Search term（AND）」との論理整合性の確認が容易になった。検証作業の時間短縮につながった。  

   • 変更ファイル（パス）  
   `main.ts`  

5. 検索結果の「ヒット行抜粋」を開発者コンソールへ出力できるように改修。
   • 課題（問題点）: ネイティブ検索のような本文抜粋が表示されず、どの行がヒットしたのか把握しづらかった。  
   • 対応内容（技術的詳細／手順）: `Excerpt` 型の新設と、行単位でヒット理由を集約する `extractHitLines()` を追加。`MatchLog` に `excerpts?: Excerpt[]` を拡張し、`runNativeLikeSearch()` 内で本文取得後に抜粋を生成・格納。最後に `console.groupCollapsed()` を用いて「行番号: 抜粋テキスト」と「reasons（どの条件でヒットしたか）」を最大10行まで出力するロギングを追加。各行のヒット理由は以下で検出:  
     - `line:` 用の AND 先読み正規表現（生成済みリテラル）を行ごとに適用。  
     - `content:` で追加した各パターンを `contentContains()` で行ごとに適用。  
     - 本文クエリが `simple/fuzzy` の場合は `prepare*Search` の `searchFn` を行テキストに適用、`regex` の場合は `regexForContentQuery.test()` を適用。  
     長すぎる行は `formatLineForLog()` で整形し、ログ過多防止のため抜粋は1ファイル最大10行に制限。  
   • 効果（定量・定性）: 検索後すぐに「どの行が・どの条件で」ヒットしたかを把握可能になり、デバッグ・調整の手戻りを削減。大規模ノートでもログ視認性が向上（グループ化・行制限でノイズ低減）。  
   • 変更ファイル: `main.ts`

6. 開発者ログの出力仕様を改善（フィルタ別の詳細内訳と不要ログの削除）。
   • 課題（問題点）: ログに不要情報が含まれ、重要指標が不明確だった。具体的には「[ANS] UI状態（line terms）」が冗長、「[ANS] 対象ファイル数」が何を指すか曖昧、集計が全フィルタまとめてで各フィルタの内訳が把握しづらい、さらに「ヒット行 ○ 件 — path」ログが重複情報だった。  
   • 対応内容（技術的詳細／手順）:  
     - 「[ANS] UI状態（line terms）」のログを削除。  
     - 「[ANS] 対象ファイル数」を「Vault内のMarkdownファイル（app.vault.getMarkdownFiles() の結果）件数」と明示するメッセージへ修正。  
     - 採用ファイルに対してフィルタ別の内訳ログを追加（file/path/tag/property/section/block/tasks/content/line/contentQuery）。各フィルタの評価基準をログに明示した上で、ファイルごとの一致件数を出力。  
       ・file/path: `matchPattern()` により各パターン一致数を集計。  
       ・tag: `getTagsForFile()`＋正規表現／集合照合で一致数を集計。  
       ・property: `matchProperty()` により一致数を集計。  
       ・section: `matchSection()`、block: `matchBlockId()` により一致数を集計。  
       ・tasks: `cache.listItems` から条件（any/todo/done）に合致するタスク件数を集計。  
       ・content: 本文全体に対して `contentContains()` で各パターン一致数を集計。  
       ・line: AND 条件でのユニーク行ヒット数（`countLineMatches_AND()` の結果）を出力。  
       ・contentQuery: simple/fuzzy は行単位で `searchFn` による一致行数、regex は本文全体の正規表現一致総数。  
       内訳集計用に `FilterHitStats` 型を追加し、採用ファイルごとに `filterHits` を格納。  
     - 重複確認可能なため「[ANS] ヒット行 ○ 件 — path」グループ出力を削除（「結果サンプル」「全結果」で確認可能）。  
   • 効果（定量・定性どちらでも可）: ログの冗長さを削減し、各フィルタがどのようにヒットしたかを明確化。デバッグの観点で検証ポイントが直感的になり、調査時間を短縮。対象ファイル範囲の誤解も防止。  
   • 変更ファイル（パスを `back-tick` で囲む）: `main.ts`

7. Sectionフィルタのヒット行を抜粋情報（excerpts）に反映。
- 課題（問題点）: Sectionフィルタで採用されたファイルでも、どの見出し行に一致したかが excerpts に出力されず、ヒット箇所が把握できない状態だった。
- 対応内容（技術的詳細／手順）: 
  - 見出しキャッシュから一致行を抽出するユーティリティを追加し、行番号と行テキストを抜粋として生成。
    - 追加関数: `offsetToLine(text, offset)`（position.start.line がない場合のフォールバック）。
    - 追加関数: `buildSectionExcerpts(app, file, text, patterns, caseSensitive)`（`sources` に `section:<pattern>` を付与）。
  - 既存の抜粋と見出し由来の抜粋を統合する関数を実装。
    - 追加関数: `mergeExcerpts(base, add, perFileLimit)`（行番号でマージ、`sources` を結合、上限適用）。
  - 検索実行ロジックで excerpts 生成後にセクション抜粋を生成・マージするよう組み込み。
    - `runNativeLikeSearch` 内で `buildSectionExcerpts(...)` を呼び出し、`mergeExcerpts(...)` で統合して `logEntry.excerpts` に設定。
- 効果（定量・定性どちらでも可）: Section一致時に「どの行・どのテキストにヒットしたか」を excerpts で確認可能になり、デバッグ性・追跡性が向上。複数パターンに同一見出しが一致した場合も、`sources` に複数の `section:<pattern>` が記録され、判定根拠が明瞭化。
- 変更ファイル（パスを `back-tick` で囲む）: `main.ts`

8. 
   • 課題（問題点）  
   本文に限定された検索は用途が分かりづらく、Vault 横断の利用ニーズを満たしていなかった。  

   • 対応内容（技術的詳細／手順）  
   - 「本文クエリ」を「Global Query」に改称し、型・変数名を包括的にリネーム（contentQuery → globalQuery、contentQueryTargets → globalQueryTargets など）。  
   - Global Query の対象を Body/Name/Path/Frontmatter/Tags/Headings に拡張し、対象内は OR（いずれか命中）で判定。  
   - simple/fuzzy は Obsidian の prepareSimpleSearch/prepareFuzzySearch を用いて文字列評価、regex は明示リテラルを優先し、それ以外はデフォルトで大文字小文字非区別に。  
   - 非本文ターゲットの命中を擬似抜粋として表示（[name] / [path] / [frontmatter] / [tag] / [headings]）。  
   - ヒット内訳に globalQueryBreakdown（target 別件数）を追加。  

   • 効果（定量・定性どちらでも可）  
   検索の網羅性・説明性が向上し、使用意図が明確化。Vault 横断の発見性が改善。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

9. 
   • 課題（問題点）  
   Global Query とフィルタの影響範囲（モード／大文字小文字）が不明瞭で誤解を招く。  

   • 対応内容（技術的詳細／手順）  
   - モーダル UI に「Global Query セクション（Mode 適用）」と「Filters セクション（Case sensitive 適用）」を明示分割し、区切り線・見出しを追加。  
   - 仕様を統一: Mode は Global Query のみ、Case sensitive は file/path/tag/content/line/headings/property の各フィルタに適用。  
   - regex（Global Query）は明示フラグ優先・非明示は非区別で統一。  

   • 効果（定量・定性どちらでも可）  
   誤設定の低減と再現性の向上。操作学習コストの削減。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

10. 
   • 課題（問題点）  
   使用しない block / task 機能がコードを複雑化し、型エラーの温床になっていた。  

   • 対応内容（技術的詳細／手順）  
   - block / task 関連の UI・型・ロジック・統計・ログを全面削除。  
   - 参照関数や内訳表示も削除し、依存コードを整理。  

   • 効果（定量・定性どちらでも可）  
   コード行数削減、ビルド安定性と可読性・保守性の向上。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

11. 
   • 課題（問題点）  
   「section」表記が実態（見出し検索）と乖離していた。  

   • 対応内容（技術的詳細／手順）  
   - section → headings に改称（UI/型/ログ/統計キーを一括更新）。  
   - matchSection → matchHeading、buildSectionExcerpts → buildHeadingExcerpts に置換。  
   - position.start.line 不在時は position.start.offset から offsetToLine で行番号を推定。  

   • 効果（定量・定性どちらでも可）  
   用語と機能の一貫性が向上し、デバッグと理解コストを削減。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

12. 
   • 課題（問題点）  
   （副次）ListItemCache.text 参照に起因する ts(2339) などの型不一致が発生していた。  

   • 対応内容（技術的詳細／手順）  
   - task 機能の全面削除により当該参照自体を排除。  
   - 行位置計算の共通化（offsetToLine の積極利用）で位置推定の一貫性を確保。  

   • 効果（定量・定性どちらでも可）  
   ビルド時エラーの解消と安定性向上。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

13. 
   • 課題（問題点）  
   コメントや UI 文言が日本語混在で国際化・コントリビューションに不利。  

   • 対応内容（技術的詳細／手順）  
   - 主要コメント／UI ラベル／ログ出力を英語に統一。  

   • 効果（定量・定性どちらでも可）  
   外部コントリビュータの参画ハードル低下、保守性向上。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

14. 
   • 課題（問題点）  
   ヒット根拠の可視性が不足し、診断が難しい。  

   • 対応内容（技術的詳細／手順）  
   - Global Query の非本文ターゲットに対し擬似抜粋を生成・統合。  
   - filterHits に globalQueryBreakdown（target 別）を追加し、console.groupCollapsed で可読性向上。  

   • 効果（定量・定性どちらでも可）  
   デバッグ効率と問題切り分けの精度が向上。  

   • 変更ファイル  
   `/workspaces/obsidian-advanced-native-search/src/main.ts`

## 2025/10/06
### 実施した対応
1. プラグインのビルドパイプライン導入と最小構成の整備。
   - 課題（問題点）  
     既存の Vault で実行可能な形で、TypeScript + esbuild によりビルドし、/plugins-output に自動出力する開発フローが未整備だった。
   - 対応内容（技術的詳細／手順）  
     - TypeScript ソースを `src/main.ts` に集約し、esbuild でバンドルして CommonJS 形式で出力する構成を作成。  
     - `external` に Obsidian/Electron/Codemirror 系を設定し、`target: es2018`、開発時はインラインソースマップ、出力先は `/plugins-output/advanced-native-search/main.js` に設定。  
     - Vault 側は出力先に `manifest.json` を置いて Obsidian が検出・有効化できる状態に統一。  
     - プラグイン機能として、非公式API観測コマンド（SearchView 監視）と公式APIログ出力コマンドを実装・登録。
   - 効果（定量・定性どちらでも可）  
     - 1コマンドで watch ビルドが立ち上がり、保存→即反映で開発ループが高速化。  
     - 出力場所を Vault プラグインフォルダへ固定し、有効化手順が簡略化。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `package.json`  
     - `esbuild.config.mjs`  
     - `tsconfig.json`  
     - `/plugins-output/advanced-native-search/manifest.json`  
     - `src/main.ts`

2. esbuild の watch オプションエラー修正（Invalid option "watch"）。
   - 課題（問題点）  
     `build({ watch })` を指定したことで、利用中の esbuild Node API が `watch` を受け付けずビルド失敗。
   - 対応内容（技術的詳細／手順）  
     - esbuild を 0.19 系に固定。  
     - Node API を `context(options).watch()` に変更し、開発時のみ watch を起動。  
     - 実行スクリプトは `node esbuild.config.mjs [production]` で dev/production を分岐。  
     - `.mjs` 実行の安定化のため `"type": "module"` を `package.json` に追加。
   - 効果（定量・定性どちらでも可）  
     - `npm run dev` で監視ビルドが安定動作し、`/plugins-output/advanced-native-search/main.js` が自動生成されるようになった。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `package.json`  
     - `esbuild.config.mjs`

3. 公式API検索の任意クエリ化（入力モーダル追加）と検索モード切替。
   - 課題（問題点）  
     公式APIログ出力が固定クエリ `"demo"` でヒットが多すぎ、任意の文字列で検索したい要件に未対応。
   - 対応内容（技術的詳細／手順）  
     - `QueryPromptModal` を追加し、実行時に任意クエリを入力可能に。  
     - 検索モードを `fuzzy`（`prepareFuzzySearch`）と `simple`（`prepareSimpleSearch`）から選択可能に。  
     - 新コマンド「ANS: Run official API search logs (prompt for query)」を追加。  
     - `runOfficialApiLogs(query, mode)` へ改修し、既存の固定クエリ版コマンドも併存。
   - 効果（定量・定性どちらでも可）  
     - 利用者が検索語やモードを都度指定でき、ヒット数やマッチ精度を実データに合わせて調整可能に。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `src/main.ts`

4. VSCode の TypeScript エラー修正（tslib 不足・null 可能性・getTags 不在）。
   - 課題（問題点）  
     - TS2354: `"importHelpers": true` だが `tslib` 未導入。  
     - TS18047: `getLeftLeaf(true)` の戻り値が `null` 可能。  
     - TS2339: `MetadataCache.getTags` は存在せずコンパイラエラー。
   - 対応内容（技術的詳細／手順）  
     - 開発依存に `tslib` を追加（または `importHelpers: false` でも可）。  
     - `leaf` へのヌルガードを追加し、取得失敗時は早期リターン。  
     - タグ収集は `CachedMetadata` から集計するユーティリティ `collectTagsFromFiles` を実装（`cache.tags` と `frontmatter.tags` を統合）。
   - 効果（定量・定性どちらでも可）  
     - VSCode の型エラーが解消し、エディタ体験が安定。  
     - タグ一覧出力が API 仕様に沿った実装となり将来互換性が向上。
   - 変更ファイル（パスを `back-tick` で囲む）  
     - `package.json`  
     - `tsconfig.json`（任意で `importHelpers` の調整）  
     - `src/main.ts`

5. 動作検証（出力生成とコマンド実行）。
   - 課題（問題点）  
     一連の修正後に、ビルド成果物の生成と Obsidian 上の動作を確認する必要があった。
   - 対応内容（技術的詳細／手順）  
     - `npm run dev` により監視ビルドを起動し、`/plugins-output/advanced-native-search/main.js` が生成されることを確認。  
     - Obsidian でプラグインを有効化し、以下コマンドを実行して結果をコンソールで確認。  
       - 「ANS: Attach native Search observer (Unofficial)」  
       - 「ANS: Run official API search logs (prompt for query)」
   - 効果（定量・定性どちらでも可）  
     - いずれのコマンドも正常に動作し、要件どおりのデータ取得・ログ出力が可能なことを確認。タスク完了。

### 今後のタスク
- 非公式API依存のリスク低減: 内部構造の変化検知ガード、型ナローイング、フェイルセーフ分岐の強化（未取得時の代替経路やユーザ通知）。
- 表示/UI の拡張: 検索結果のカード表示・プレビュー・並び替え・ページング、設定タブでの既定クエリ/モード/ハイライト設定の保存。
- パフォーマンス最適化: 大規模 Vault でのファイル読み込み分割、検索対象の限定（フォルダ/拡張子/サイズ）、非同期キューイング。
- クエリ支援: 入力モーダルに履歴・補完（Suggest）・プリセット（tag:/file:/[property] 例）を追加。
- テスト/型整備: 内部 SearchView のテストダブルや型インターフェイス定義、Obsidian バージョン差分の検証 CI。